<!doctype html>
<html lang="en-IN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Club Mahabaleshwar — Booking</title>
  <meta name="theme-color" content="#6abf8a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/logo.png">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.min.js"></script>
  <script>dayjs.extend(dayjs_plugin_isoWeek);dayjs.extend(dayjs_plugin_customParseFormat);</script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<header class="site-header">
  <img src="assets/logo.png" class="logo" alt="Club Logo">
  <div class="titles">
    <h1>The Club Mahabaleshwar <span class="badge">New</span></h1>
    <p class="subtitle">Member Room Booking</p>
  </div>
  <nav>
    <button id="btnLogin" class="button ghost">Login</button>
    <button id="btnDemo" class="button ghost">Demo</button>
    <a href="admin/" class="button ghost">Admin</a>
    <a href="admin/promotions.html" class="button ghost">Promotions</a>
  </nav>
</header>

<main class="container">
  <div id="demoBanner" class="notice" style="display:none">Continuing in demo mode.</div>

  <div class="grid2">
    <section class="card cal">
      <div class="cal-head">
        <h2>Date selection</h2>
        <div class="actions">
          <button id="prev" class="button ghost">←</button>
          <button id="next" class="button ghost">→</button>
          <div class="pill sel">CI: <span id="ciChip">—</span> • CO: <span id="coChip">—</span></div>
        </div>
      </div>
      <div class="cal-head muted"><div id="monthLbl">Month</div></div>
      <div id="calGrid" class="cal-grid" aria-label="calendar grid"></div>
      <div class="cal-legend">
        <span class="pill open">Open</span>
        <span class="pill partial">Partial</span>
        <span class="pill closed">Closed</span>
        <span class="pill sel">Selected range</span>
      </div>
    </section>

    <section class="card">
      <h2>Availability</h2>
      <div id="availability" class="muted">Pick your dates to see rooms. “Partial” means available for some nights in the range.</div>
    </section>
  </div>

  <section class="card">
    <h2>Summary</h2>
    <div id="summary" class="summary-box muted">Select your dates from the calendar above.</div>
    <footer>Data is read from <code>/data/rooms.json</code>, <code>/data/calendar.json</code>, and <code>/data/members.csv</code>. No server required.</footer>
  </section>

  <div class="legacy" style="display:none">
    <input id="checkin" type="date">
    <input id="checkout" type="date">
    <div id="memberInfo"></div>
  </div>
</main>

<script src="app.js"></script>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const grid=$('#calGrid'), monthLbl=$('#monthLbl'), ciChip=$('#ciChip'), coChip=$('#coChip');
  const summary=$('#summary'), availability=$('#availability'), demoBanner=$('#demoBanner');
  const fmt=d=>dayjs(d).format('DD/MM/YYYY'); const iso=d=>dayjs(d).format('YYYY-MM-DD');
  let state={monthStart:dayjs().startOf('month'), ci:null, co:null, cal:{closed:[],open_override:[],special:[]}, rooms:[]};

  function renderMonth(){
    monthLbl.textContent=state.monthStart.format('MMMM YYYY');
    grid.innerHTML='';
    const start=state.monthStart.startOf('week');
    for(let i=0;i<42;i++){
      const d=start.add(i,'day'); const inMonth=d.month()===state.monthStart.month();
      const div=document.createElement('div'); div.className='cell'+(inMonth?'':' muted');
      const ds=iso(d); if(state.cal.closed.includes(ds)) div.classList.add('closed');
      const sel=state.ci&&state.co&&d.isAfter(state.ci.subtract(1,'day'))&&d.isBefore(state.co.add(1,'day')); if(sel) div.classList.add('sel');
      div.innerHTML=`<div class="wk">${d.format('ddd')}</div><div class="d">${d.date()}</div>`;
      div.addEventListener('click',()=>pickDate(d)); grid.appendChild(div);
    }
    ciChip.textContent=state.ci?fmt(state.ci):'—'; coChip.textContent=state.co?fmt(state.co):'—';
  }
  function pickDate(d){
    if(!state.ci||(state.ci&&state.co)){state.ci=d;state.co=null;}
    else if(d.isBefore(state.ci)){state.ci=d;} else {state.co=d;}
    renderMonth(); renderSummary(); if(state.ci&&state.co) showAvailability();
  }
  function renderSummary(){
    if(!(state.ci&&state.co)){summary.textContent='Select check-in then check-out.';return;}
    const nights=state.co.diff(state.ci,'day'); summary.innerHTML=`<b>${fmt(state.ci)} → ${fmt(state.co)}</b> • ${nights} night(s)`;
  }
  function overlaps(aStart,aEnd,bStart,bEnd){return !(bEnd.isBefore(aStart)||bStart.isAfter(aEnd));}
  function showAvailability(){
    const from=state.ci, to=state.co.subtract(1,'day'); const full=[], partial=[];
    state.rooms.forEach(r=>{
      const anyBlock=(r.blackouts||[]).some(([s,e])=>overlaps(from,to,dayjs(s),dayjs(e)));
      if(!anyBlock) full.push(r.id);
      else{
        let avail=[]; for(let d=from; d.isBefore(state.co); d=d.add(1,'day')){
          const blocked=(r.blackouts||[]).some(([s,e])=>overlaps(d,d,dayjs(s),dayjs(e))); if(!blocked) avail.push(d.format('DD/MM'));
        }
        partial.push({id:r.id,nights:avail});
      }
    });
    const fullHtml=full.length?`<h3>Fully available</h3><div class="list">${full.map(id=>`<div class="room"><div class="id">${id}</div></div>`).join('')}</div>`:'<p class="muted">No rooms fully available.</p>';
    const partHtml=partial.length?`<h3>Partial</h3><div class="list">${partial.map(p=>`<div class="room"><div class="id">${p.id}</div><div class="muted">${p.nights.join(', ')}</div></div>`).join('')}</div>`:'';
    availability.innerHTML=fullHtml+partHtml;
    localStorage.setItem('lastBooking', JSON.stringify({member:{id:'Guest',name:'Guest'},ci:from.toISOString(),co:state.co.toISOString(),rooms:full.slice(0,1),pax:{adults:2,children:0},createdAt:new Date().toISOString()}));
  }
  $('#prev').addEventListener('click',()=>{state.monthStart=state.monthStart.subtract(1,'month');renderMonth();});
  $('#next').addEventListener('click',()=>{state.monthStart=state.monthStart.add(1,'month');renderMonth();});
  $('#btnDemo').addEventListener('click',()=>{demoBanner.style.display='block';localStorage.setItem('demo','1');}); if(localStorage.getItem('demo')==='1') demoBanner.style.display='block';

  Promise.all([fetch('data/calendar.json?v='+Date.now()).then(r=>r.json()), fetch('data/rooms.json?v='+Date.now()).then(r=>r.json())]).then(([cal,rooms])=>{state.cal=cal;state.rooms=rooms;renderMonth();});
})();
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}
</script>
</body></html>
